---
title: "DataCollection"
author: "Leo Kitchell"
date: "11/29/2021"
output: html_document
---

```{r, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```

## Purpose
The purpose of this document is to gather data from different sources for my senior thesis. This includes pulling ACS 5 Year data from the census using their API, combining the data from InsideAirbnb, and compiling all other data needed to create my measure of gentrification

```{r}
runtime <- list() #creating a list to track how long each code chunk takes to run on my machine
```

```{r, include=FALSE}
#Installing relevant packages and libraries
runtime$packagesAndLibraries<-Sys.time()
#install.packages("censusapi")
#install.packages("quanteda")
#install.packages("stopwords")
#install.packages("httr")
#install.packages("jsonlite")
#install.packages("tidycensus")
#install.packages('tigris')
#install.packages("leaflet")
#library(tidycensus)
library(acs)
library(lubridate)
library(leaflet)
library(tigris)
library(stopwords)
library(quanteda)
library(censusapi)
library(stringr)
library(dplyr)
library(tidyr)
library(httr)
library(jsonlite)
runtime$packagesAndLibraries<-Sys.time()-runtime$packagesAndLibraries
```

# Airbnb Data
Data has been downloaded from InsideAirbnb for 28 US cities. These data are composed of 3 files for each city. The first file includes every listing within the metropolitan area, a second file contains every review for each listing, and the third contains a forward looking calendar showing the listing's available nights and the price for each night. 

## Stacking Data
Using rbind to stack airbnb data from each filetype (Listings, Calendar, and Reviews) into three dataframes.
```{r, cache=TRUE}
runtime$stackingData <- Sys.time()
file_list = list.files("./InsideAirbnbData/Zipped_Data/",'*.csv')

listing_data <- array()

for (variable in file_list) {
  if(grepl("listings",variable,fixed=TRUE)){
      listing_data <- rbind(listing_data,read.csv(paste(path,variable,sep = "")))
  } 
}
listing_data <- listing_data %>% filter(!is.na(id)) #removes rows with NA listing IDs. 

runtime$stackingData <- Sys.time()- runtime$stackingData 
```

## Geocoding Airbnb Listings
Mapping latitude to blocks and tracts. Predicted to take ~200 minutes per vintage. 
```{r, cache=TRUE, eval=FALSE}
runtime$geocodingAirbnbs <- Sys.time()
#listing_data$fullFIPS2000<- "" #creating empty columns to be populated by the loop below
#listing_data$tractFIPS2000 <- ""
#listing_data$fullFIPS2010<- ""
#listing_data$tractFIPS2010 <- ""
#vintage <- c(2000,2010)

#for (year in vintage) {
  for (listing in 1:nrow(listing_data)) {
  lat = listing_data$latitude[listing]
    long = listing_data$longitude[listing]
    url <- paste("https://geo.fcc.gov/api/census/block/find?latitude=",lat,"&longitude=",long,"&censusYear=",2010,"&format=json",sep = "")
    response = GET(url)
    blockData <- response$content%>%rawToChar()%>%fromJSON()
    
    if(is.null(blockData$Block$FIPS)){
        listing_data$fullFIPS2010[listing]<-NA
        listing_data$tractFIPS2010[listing]<-NA
    }else{
        listing_data$fullFIPS2010[listing] <- blockData$Block$FIPS
        listing_data$tractFIPS2010[listing] <- substr(listing_data$fullFIPS2010[listing],1,11)
    }
    if(listing%%1000==0) {
      print(paste(listing,"listings geolocated"))
    }
  }
#}

listing_data <- listing_data %>% subset(select = -c(host_url,picture_url,host_has_profile_pic))   # removing data that wont be used to save space
listing_data$stateAndCountyFIPS2000 <- substr(listing_data$tractFIPS2000,1,5)  #creating a variable for the state and county fips from the tract fips code so that census data can be can be merged
listing_data$stateAndCountyFIPS2010 <- substr(listing_data$tractFIPS2010,1,5)
write.csv(listing_data, file=gzfile("listing_data_11_29.csv.gz", compression = 9),row.names = FALSE)

runtime$geocodingAirbnbs <- Sys.time() - runtime$geocodingAirbnbs
```

## Reading in Geocoded Airbnb Listings
For efficiency, the **Geocoding Airbnb Listings** section has been set to not evaluate, and the data which it generated is read in here.
```{r}
listing_data <- read.csv(file = "listing_data_11_29.csv.gz",colClasses = c("fullFIPS2000"="character","fullFIPS2010"="character",
                                                                           "tractFIPS2000"="character","tractFIPS2010"="character",
                                                                           "stateAndCountyFIPS2000"="character","stateAndCountyFIPS2010"="character")) #listings that have already been geocoded.
```

# Gentrification Data

## Specification
The specification of gentrification which will be used in this project is heavily inspired by the work of Freeman (2005) and Bates (2013). To compose our gentrification measure we will use Census tract level data on median household income, educational attainment, and percentage of income spent on rent. **The rent measure may have to be changed to dollar amount spent on rent so that we don't get confonding from increased household income in the tract** 

## Census Variables
These variables will be used to determine the gentrification in a given neighborhood.
Descriptions and codes of variables available in the ACS 5 year dataset located here: https://www.socialexplorer.com/data/ACS2019_5yr/metadata/?ds=ACS19_5yr
```{r}
#Control Variables
locationName <- "NAME"    #Census geography name
totalPop <- "B01003_001E" #Census table for total population

#Education Variables
  educationPop <- "B15003_001E" #Number of respondents 25 Years and Over who responded to education portion of survey
  bachelorsPop <- "B15003_022E" #Number of respondents 25 Years and Over with a bachelors degree
  mastersPop <-   "B15003_023E" #Number of respondents 25 Years and Over with a masters degree
  professionalPop <-"B15003_024E" #Number of respondents 25 Years and Over with a professional degree
  doctoratePop <-"B15003_025E" #Number of respondents 25 Years and Over with a doctorate degree
  
#Gentrification Variables
medHHInc <- "B19013_001E" #Median household income in inflation adjusted dollars of VINTAGE year (e.g. 2014, 2019).
medGrossRent <- "B25064_001E" #Median Gross Rent (Dollars)
educationVars <- c(educationPop,bachelorsPop,mastersPop,professionalPop,doctoratePop)

censusVars <- c(locationName,totalPop,medHHInc,medGrossRent,educationVars)

#Other Variables Considered
  #rentGrossAsPctInc <- "B25070_001E" #Gross Rent As A Percentage Of Household Income In The Past 12 Months
  #medRentAsPctInc <- "B25071_001E" #	Median Gross Rent As A Percentage Of Household Income In The Past 12 Months (Dollars)
  #rawRent <-"B25056_001E" #Contract Rent
```

### Setup Census API key to pull data.
```{r}
# Add key to .Renviron
key = "be936e1698dd7dfd657546a6a7088c6306f4e54f"
Sys.setenv(CENSUS_KEY= key)
# Reload .Renviron
readRenviron("~/.Renviron")
# Check to see that the expected key is output in your R console
Sys.getenv("CENSUS_KEY")
```

### Pulling Data from Census API
Compiling Census Data for all tracts within the States included in the AirBnB data
```{r, cache=TRUE,results='hide'}
runtime$pullingCensus <- Sys.time()
listing_data$state <- substr(listing_data$stateAndCountyFIPS2010,1,2)
includedStates <- listing_data %>% group_by(nchar(stateAndCountyFIPS2010)) %>% summarize() %>% drop_na()
includedStates <- listing_data %>% group_by(listing_data$state) %>% summarize() %>% drop_na()
names(includedStates)<-"state_FIPS"

nameACS <- "acs/acs5"
vintage <- c(2014,2019)
region <- "tract:*"

censusDataRaw <- data.frame()
for (year in vintage) {
  for (fipsCode in includedStates$state_FIPS) {
    state = paste("state:",fipsCode,"+county:*",sep = "")
    print(paste("Now pulling census data for Geography:",state," from vintage:",year))
    stateData <- getCensus(name = nameACS,vintage = year, vars = censusVars, regionin = state, region = region)
    stateData$vintage <- year
    censusDataRaw <- rbind(censusDataRaw,stateData)
  }
}

censusData <- censusDataRaw %>% mutate(tractFIPS = paste(state,county,tract,sep = ""), stateAndCountyFIPS = paste(state,county,sep = ""))
censusData <- semi_join(censusData,listing_data, by = c("tractFIPS"="tractFIPS2010"))
runtime$pullingCensus <- Sys.time()-runtime$pullingcensus
```

### Selecting MSAs
Filtering censusData to tracts contained within MSAs.
```{r}
setwd("./OtherData")
cbsasRaw <- read.csv("CBSAs_March_2020.csv",header = TRUE,colClasses=c("FIPS.State.Code"="character","FIPS.County.Code"="character"))  #Census delineation file downloaded from "https://www.census.gov/geographies/reference-files/time-series/demo/metro-micro/delineation-files.html" with first two rows deleted and saved as csv.
cbsas <- cbsasRaw %>% subset(select=c("CBSA.Title","CBSA.Code","Metropolitan.Micropolitan.Statistical.Area","FIPS.State.Code","FIPS.County.Code")) %>% mutate(FIPS.State.And.County.Code = paste(FIPS.State.Code,FIPS.County.Code,sep = ""))

censusData<- semi_join(censusData,cbsas,by = c("stateAndCountyFIPS"="FIPS.State.And.County.Code"))  #removes all census data from outside of MSAs. 
includedMSAs <- semi_join(cbsas, censusData,by = c("FIPS.State.And.County.Code"="stateAndCountyFIPS"))  
```

### Creating Education Variable, Renaming Gentrification Variables to be Informative
```{r, results='hide'}
runtime$creatingGentrificationVariables <- Sys.time()
censusData$pctBachelorsOrHigher <- ((censusData$B15003_022E+censusData$B15003_023E+censusData$B15003_024E+censusData$B15003_025E)/censusData$B15003_001E)
censusData <- rename(.data = censusData,"totalPop"=totalPop,"medHHInc"=medHHInc,"medGrossRent"=medGrossRent)

censusData <- inner_join(censusData,includedMSAs,c("stateAndCountyFIPS"="FIPS.State.And.County.Code"))
censusData <- subset(censusData,select = -c(Metropolitan.Micropolitan.Statistical.Area,FIPS.State.Code,FIPS.County.Code))

censusData <- censusData %>% mutate(across(where(is.double),~na_if(.,-666666666)))   #replaces all instances of -666666666	with "NA"

vintage <- c(2014,2019)

uniqueMSAs <- distinct(includedMSAs,CBSA.Code)
names(uniqueMSAs)
censusDataWithDistributions <- data.frame()
for (year in vintage) {
  for (city in uniqueMSAs$CBSA.Code) {
    cityCensusData <- censusData %>% filter(vintage==year,CBSA.Code==city)
    educDist <- ecdf(cityCensusData$pctBachelorsOrHigher)
    cityCensusData$pctileBachelorsOrHigher <- educDist(cityCensusData$pctBachelorsOrHigher)
    incDist  <- ecdf(cityCensusData$medHHInc)
    cityCensusData$pctilemedHHInc <- incDist(cityCensusData$medHHInc)
    rentDist <- ecdf(cityCensusData$medGrossRent)
    cityCensusData$pctilemedGrossRent <- rentDist(cityCensusData$medGrossRent)
    
    censusDataWithDistributions <- rbind(censusDataWithDistributions,cityCensusData)
  }
}

runtime$creatingGentrificationVariables <- Sys.time() - runtime$creatingGentrificationVariables
```

## Calculating Gentrification Index by Tract
```{r}
# calculate average index
censusDataWithDistributions <- censusDataWithDistributions %>% mutate(gentrificationIndex = (pctilemedHHInc + pctilemedGrossRent + pctileBachelorsOrHigher)/3)
hist(censusDataWithDistributions$gentrificationIndex)

censusDataWithDistributionsWide <- reshape(censusDataWithDistributions, idvar = "tractFIPS", timevar = "vintage", direction = "wide")
censusDataWithDistributionsWide <- censusDataWithDistributionsWide %>% mutate(gentrificationChange = gentrificationIndex.2019 - gentrificationIndex.2014)
hist(censusDataWithDistributionsWide$gentrificationChange,breaks = 20)
```

### Calculating Population Growth by Tract
```{r}
censusDataWithDistributionsWide <- censusDataWithDistributionsWide %>% mutate(popGrowth = ((totalPop.2019 - totalPop.2014)/totalPop.2014))
```

### Pulling Geometries to Map
```{r,results='hide'}
runtime$mapping <- Sys.time()
tractGeom <- data.frame()
 for (fipsCode in includedStates$state_FIPS) {
    stateTractGeom <- tracts(state = fipsCode)
    tractGeom <- rbind(tractGeom,stateTractGeom)
}

tractGeom1 <- tractGeom %>% subset(select=c("GEOID","geometry"))
censusDataWithDistributionsWideGeoms <- geo_join(data_frame = censusDataWithDistributionsWide,spatial_data = tractGeom1,by_df = "tractFIPS",by_sp = "GEOID")
```

## Mapping Gentrification Index by MSA - All Tracts
```{r, warning=FALSE}
ii=1
cityMaps <- ""
for (MSA in uniqueMSAs$CBSA.Code) {
  cityCensusData <- filter(censusDataWithDistributionsWideGeoms,censusDataWithDistributionsWideGeoms$CBSA.Code.2014==MSA)
  cityMaps[ii] <- plot(cityCensusData["gentrificationChange"],main=paste("Gentrification Change 2014-2019 in",cityCensusData$CBSA.Title.2014[1]))
  ii<-ii+1
}
runtime$mapping <- Sys.time() - runtime$mapping
```
## Restricting to Gentrifiable Neighborhoods
Following Ding (2016) we will restrict our analysis to only include neighborhoods which had median household income below the citywide median at the beginning of our period of analysis (2009-2014)
```{r}
gentrifiableCensusDataWithDistributionsWideGeoms <- censusDataWithDistributionsWideGeoms %>% filter(pctilemedHHInc.2014<0.5)
gentrifiableCensusDataWithDistributionsWide <- censusDataWithDistributionsWide %>% filter(pctilemedHHInc.2014<0.5)
```

## Mapping Gentrification Index by MSA - Gentrifiable Tracts
```{r, warning=FALSE}
ii=1
gentrifiableCityMaps <- ""
for (MSA in uniqueMSAs$CBSA.Code) {
  cityCensusData <- filter(gentrifiableCensusDataWithDistributionsWideGeoms,
                           gentrifiableCensusDataWithDistributionsWideGeoms$CBSA.Code.2014==MSA)
  if (nrow(cityCensusData)>0) {
    cityMaps[ii] <- plot(cityCensusData["gentrificationChange"],
                         main=paste("Gentrification Change 2014-2019 in",
                                    cityCensusData$CBSA.Title.2014[1]),)}
  ii<-ii+1
}
runtime$mapping <- Sys.time() - runtime$mapping
```
# Saving Relevant Data 
Saving compiled data to a .RData file for processing in a separate .Rmd file. 
```{r}
save(list = c("listing_data","gentrifiableCensusDataWithDistributionsWide","includedStates"), file = "Compiled_Thesis_Data.RData")
```